// Prisma schema for Ticketing System

generator client {
  provider      = "prisma-client-js"
  // Must match production OS. "debian-openssl-3.0.x" is for Azure App Service (Linux) and Debian with OpenSSL 3.
  // If you deploy to Windows App Service or another Linux base, add that target or generate on the target machine.
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum TicketStatus {
  NEW
  TRIAGED
  ASSIGNED
  IN_PROGRESS
  WAITING_ON_REQUESTER
  WAITING_ON_VENDOR
  RESOLVED
  CLOSED
  REOPENED
}

enum TicketPriority {
  P1
  P2
  P3
  P4
}

enum TicketChannel {
  PORTAL
  EMAIL
}

enum MessageType {
  PUBLIC
  INTERNAL
}

enum TeamRole {
  AGENT
  LEAD
  ADMIN
}

enum TeamAssignmentStrategy {
  QUEUE_ONLY
  ROUND_ROBIN
}

enum UserRole {
  EMPLOYEE
  AGENT
  LEAD
  // ADMIN is deprecated and scheduled for removal.
  // Migration 20260202220000 already converted all ADMIN rows to TEAM_ADMIN.
  // Kept temporarily for backward compatibility; remove once confirmed unused.
  ADMIN   // @deprecated – use TEAM_ADMIN or OWNER
  TEAM_ADMIN
  OWNER
}

enum AccessLevel {
  READ
  WRITE
}

enum NotificationChannel {
  EMAIL
}

enum OutboxStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
}

enum AttachmentScanStatus {
  PENDING
  CLEAN
  INFECTED
  FAILED
}

enum NotificationType {
  TICKET_ASSIGNED
  TICKET_UPDATED
  NEW_MESSAGE
  TICKET_MENTIONED
  SLA_AT_RISK
  SLA_BREACHED
  TICKET_RESOLVED
  TICKET_TRANSFERRED
}

enum SlaNotifyRole {
  AGENT
  LEAD
  MANAGER
  OWNER
}

model User {
  id                 String        @id @default(uuid())
  email              String        @unique
  displayName        String
  department         String?
  location           String?
  graphProfile       Json?
  role               UserRole      @default(EMPLOYEE)
  primaryTeamId      String?       // for TEAM_ADMIN: the team they administer
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  teamMemberships    TeamMember[]
  primaryTeam        Team?         @relation("UserPrimaryTeam", fields: [primaryTeamId], references: [id])
  requestedTickets   Ticket[]      @relation("TicketRequester")
  assignedTickets    Ticket[]      @relation("TicketAssignee")
  messages           TicketMessage[]
  events             TicketEvent[]
  ticketFollows      TicketFollower[]
  notificationOutbox NotificationOutbox[]
  attachments        Attachment[]
  lastAssignedTeams  Team[]        @relation("TeamLastAssigned")
  notifications      Notification[]
  actedNotifications Notification[] @relation("NotificationActor")
  savedViews         SavedView[]
  cannedResponses    CannedResponse[]
  automationRulesCreated AutomationRule[]
  routingRulesAssigned RoutingRule[] @relation("RoutingRuleAssignee")
  slaPolicyConfigsCreated SlaPolicyConfig[] @relation("SlaPolicyConfigCreatedBy")
  adminAuditEvents AdminAuditEvent[] @relation("AdminAuditEventCreatedBy")
}

model Team {
  id          String       @id @default(uuid())
  name        String
  slug        String       @unique
  description String?
  assignmentStrategy TeamAssignmentStrategy @default(QUEUE_ONLY)
  lastAssignedUserId String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  members     TeamMember[]
  primaryTeamUsers User[]  @relation("UserPrimaryTeam")
  tickets     Ticket[]
  ticketAccess TicketAccess[]
  routingRules RoutingRule[]
  slaPolicyAssignments SlaPolicyAssignment[]
  lastAssignedUser User?   @relation("TeamLastAssigned", fields: [lastAssignedUserId], references: [id])
  savedViews   SavedView[]
  cannedResponses CannedResponse[]
  customFields CustomField[]
  automationRules AutomationRule[]
  adminAuditEvents AdminAuditEvent[] @relation("AdminAuditEventTeam")
}

model Category {
  id          String     @id @default(uuid())
  name        String
  slug        String     @unique
  description String?
  isActive    Boolean    @default(true)
  parentId    String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  parent      Category?  @relation("CategoryParent", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryParent")
  tickets     Ticket[]
  customFields CustomField[]

  @@index([parentId])
}

model TeamMember {
  id        String    @id @default(uuid())
  teamId    String
  userId    String
  role      TeamRole  @default(AGENT)
  createdAt DateTime  @default(now())

  team      Team      @relation(fields: [teamId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
  @@index([userId])
}

model Ticket {
  id             String         @id @default(uuid())
  number         Int            @unique @default(autoincrement())
  displayId      String?        @unique
  subject        String         @db.VarChar(200)
  description    String         @db.Text
  status         TicketStatus   @default(NEW)
  priority       TicketPriority @default(P3)
  channel        TicketChannel  @default(PORTAL)
  requesterId    String
  assignedTeamId String?
  assigneeId     String?
  categoryId     String?
  dueAt          DateTime?
  firstResponseDueAt DateTime?
  firstResponseAt DateTime?
  slaPausedAt    DateTime?
  resolvedAt     DateTime?
  closedAt       DateTime?
  completedAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  requester      User           @relation("TicketRequester", fields: [requesterId], references: [id])
  assignedTeam   Team?          @relation(fields: [assignedTeamId], references: [id])
  assignee       User?          @relation("TicketAssignee", fields: [assigneeId], references: [id])
  category       Category?      @relation(fields: [categoryId], references: [id])
  messages       TicketMessage[]
  events         TicketEvent[]
  accessGrants   TicketAccess[]
  followers      TicketFollower[]
  attachments    Attachment[]
  notificationOutbox NotificationOutbox[]
  slaInstance    SlaInstance?
  notifications  Notification[]
  customFieldValues CustomFieldValue[]
  automationExecutions AutomationExecution[]

  @@index([status, updatedAt])
  @@index([assignedTeamId, status, updatedAt])
  @@index([assigneeId, status, updatedAt])
  @@index([requesterId, createdAt])
  @@index([dueAt])
  @@index([completedAt])
  @@index([categoryId])
  @@index([priority])
  @@index([createdAt])
  @@index([firstResponseDueAt])
}

model CustomField {
  id          String   @id @default(uuid())
  name        String
  fieldType   String   // TEXT, TEXTAREA, NUMBER, DROPDOWN, MULTISELECT, DATE, CHECKBOX, USER
  options     Json?    // For dropdown/multiselect: [{value, label}]
  isRequired  Boolean  @default(false)
  teamId      String?
  team        Team?    @relation(fields: [teamId], references: [id])
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  values      CustomFieldValue[]

  @@index([teamId])
  @@index([categoryId])
}

model CustomFieldValue {
  id            String      @id @default(uuid())
  ticketId      String
  ticket        Ticket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  customFieldId String
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  value         String?     @db.Text
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([ticketId, customFieldId])
  @@index([ticketId])
  @@index([customFieldId])
}

model TicketMessage {
  id        String      @id @default(uuid())
  ticketId  String
  authorId  String
  type      MessageType @default(PUBLIC)
  body      String      @db.Text
  createdAt DateTime    @default(now())

  ticket    Ticket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author    User        @relation(fields: [authorId], references: [id])

  @@index([ticketId, createdAt])
  @@index([authorId])
}

model TicketEvent {
  id          String   @id @default(uuid())
  ticketId    String
  type        String
  payload     Json?
  createdAt   DateTime @default(now())
  createdById String?

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  createdBy   User?    @relation(fields: [createdById], references: [id])

  @@index([ticketId, createdAt])
  @@index([type])
  @@index([createdById])
}

model AdminAuditEvent {
  id          String   @id @default(uuid())
  type        String
  payload     Json?
  teamId      String?
  createdById String?
  // Snapshot fields (8.1 fix): preserve attribution even if user/team is deleted
  actorEmail  String?
  actorName   String?
  teamName    String?
  createdAt   DateTime @default(now())

  team        Team?    @relation("AdminAuditEventTeam", fields: [teamId], references: [id], onDelete: SetNull)
  createdBy   User?    @relation("AdminAuditEventCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([type])
  @@index([teamId])
  @@index([createdById])
}

model TicketAccess {
  id          String      @id @default(uuid())
  ticketId    String
  teamId      String
  accessLevel AccessLevel @default(READ)
  createdAt   DateTime    @default(now())

  ticket      Ticket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  team        Team        @relation(fields: [teamId], references: [id])

  @@unique([ticketId, teamId])
}

model RoutingRule {
  id        String   @id @default(uuid())
  name      String
  keywords  String[]
  teamId    String
  assigneeId String?
  priority  Int      @default(100)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team      Team     @relation(fields: [teamId], references: [id])
  assignee  User?    @relation("RoutingRuleAssignee", fields: [assigneeId], references: [id])

  @@index([teamId])
  @@index([assigneeId])
}

model SlaPolicyConfig {
  id                     String                 @id @default(uuid())
  name                   String
  description            String?
  isDefault              Boolean                @default(false)
  enabled                Boolean                @default(true)
  businessHoursOnly      Boolean                @default(true)
  escalationEnabled      Boolean                @default(true)
  escalationAfterPercent Int                    @default(80)
  breachNotifyRoles      SlaNotifyRole[]         @default([AGENT, LEAD])
  createdById            String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt

  createdBy              User?                  @relation("SlaPolicyConfigCreatedBy", fields: [createdById], references: [id])
  targets                SlaPolicyConfigTarget[]
  assignments            SlaPolicyAssignment[]
  instances              SlaInstance[]          @relation("SlaInstancePolicyConfig")

  @@index([isDefault])
  @@index([enabled])
}

model SlaPolicyConfigTarget {
  id                 String         @id @default(uuid())
  policyConfigId     String
  priority           TicketPriority
  firstResponseHours Int
  resolutionHours    Int
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  policy             SlaPolicyConfig @relation(fields: [policyConfigId], references: [id], onDelete: Cascade)

  @@unique([policyConfigId, priority])
}

model SlaPolicyAssignment {
  id             String         @id @default(uuid())
  policyConfigId String
  teamId         String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  policy         SlaPolicyConfig @relation(fields: [policyConfigId], references: [id], onDelete: Cascade)
  team           Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId])
  @@unique([policyConfigId, teamId])
}

model SlaBusinessHoursSetting {
  id        String   @id @default("global")
  timezone  String   @default("UTC")
  schedule  Json
  holidays  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SlaInstance {
  id                    String         @id @default(uuid())
  ticketId              String         @unique
  policyConfigId        String?
  priority              TicketPriority
  firstResponseDueAt    DateTime?
  resolutionDueAt       DateTime?
  pausedAt              DateTime?
  nextDueAt             DateTime?
  firstResponseAtRiskNotifiedAt DateTime?
  resolutionAtRiskNotifiedAt  DateTime?
  firstResponseBreachedAt DateTime?
  resolutionBreachedAt  DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  ticket                Ticket         @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  policyConfig          SlaPolicyConfig? @relation("SlaInstancePolicyConfig", fields: [policyConfigId], references: [id])

  @@index([nextDueAt])
  @@index([policyConfigId])
  @@index([resolutionDueAt])
}

model TicketFollower {
  id        String   @id @default(uuid())
  ticketId  String
  userId    String
  createdAt DateTime @default(now())

  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([ticketId, userId])
  @@index([ticketId])
  @@index([userId])
}

model NotificationOutbox {
  id        String             @id @default(uuid())
  channel   NotificationChannel @default(EMAIL)
  status    OutboxStatus       @default(PENDING)
  eventType String
  toEmail   String
  toUserId  String?
  ticketId  String?
  subject   String
  body      String
  payload   Json?
  attempts  Int                @default(0)
  lastError String?
  sentAt    DateTime?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  toUser    User?              @relation(fields: [toUserId], references: [id])
  ticket    Ticket?            @relation(fields: [ticketId], references: [id])

  @@index([status, createdAt])
  @@index([toEmail])
  @@index([ticketId])
}

model Attachment {
  id           String               @id @default(uuid())
  ticketId     String
  uploadedById String
  fileName     String
  contentType  String
  sizeBytes    Int
  storageKey   String
  scanStatus   AttachmentScanStatus @default(PENDING)
  scanCheckedAt DateTime?
  scanError    String?
  createdAt    DateTime             @default(now())

  ticket       Ticket               @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  uploadedBy   User                 @relation(fields: [uploadedById], references: [id])

  @@index([ticketId])
  @@index([ticketId, createdAt])
  @@index([uploadedById])
  @@index([scanStatus])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  body      String?
  ticketId  String?
  actorId   String?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  user      User             @relation(fields: [userId], references: [id])
  ticket    Ticket?          @relation(fields: [ticketId], references: [id])
  actor     User?            @relation("NotificationActor", fields: [actorId], references: [id])

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([ticketId])
}

model SavedView {
  id        String   @id @default(uuid())
  name      String
  filters   Json
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  teamId    String?
  team      Team?    @relation(fields: [teamId], references: [id])
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([teamId])
}

model CannedResponse {
  id        String   @id @default(uuid())
  name      String
  content   String   @db.Text
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  teamId    String?
  team      Team?    @relation(fields: [teamId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([teamId])
}

model AutomationRule {
  id          String   @id @default(uuid())
  name        String
  description String?
  trigger     String   // TICKET_CREATED, STATUS_CHANGED, SLA_APPROACHING, SLA_BREACHED
  conditions  Json     // Array of condition objects: { field, operator, value } or { and/or: [...] }
  actions     Json     // Array of action objects: { type, ...params }
  isActive    Boolean  @default(true)
  priority    Int      @default(0)  // Lower = run first
  teamId      String?
  team        Team?    @relation(fields: [teamId], references: [id])
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  executions  AutomationExecution[]

  @@index([trigger])
  @@index([teamId])
  @@index([isActive])
}

model AutomationExecution {
  id         String   @id @default(uuid())
  ruleId     String
  rule       AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  ticketId   String
  ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  trigger    String   // TICKET_CREATED, STATUS_CHANGED, SLA_APPROACHING, SLA_BREACHED — used for de-dupe
  success    Boolean
  error      String?  @db.Text
  executedAt DateTime @default(now())

  @@index([ruleId])
  @@index([ticketId])
  @@index([ruleId, ticketId, trigger])
  @@index([executedAt])
}
